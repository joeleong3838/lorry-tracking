<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMW Lorry Tracking System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --pmw-navy: #2B3E7E;
            --pmw-cyan: #00A8E1;
            --pmw-dark: #1a2850;
            --pmw-light: #e8f4f8;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, var(--pmw-navy) 0%, var(--pmw-cyan) 100%);
            min-height: 100vh;
        }

        /* ========================================
           TERMS & CONDITIONS LANDING PAGE
        ======================================== */
        #termsPage {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .terms-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .terms-header {
            background: linear-gradient(135deg, var(--pmw-cyan) 0%, var(--pmw-navy) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .terms-header h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .terms-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .terms-content {
            padding: 40px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .terms-content h2 {
            color: #1a1a2e;
            font-size: 22px;
            font-weight: 700;
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .terms-content h2:first-child {
            margin-top: 0;
        }

        .terms-content p, .terms-content li {
            color: #4a5568;
            line-height: 1.8;
            margin-bottom: 12px;
        }

        .terms-content ul {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .terms-content strong {
            color: #2d3748;
            font-weight: 600;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 16px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .warning-box strong {
            color: #856404;
        }

        .terms-footer {
            padding: 30px 40px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
        }

        .checkbox-container label {
            color: #2d3748;
            font-size: 15px;
            cursor: pointer;
            user-select: none;
        }

        .accept-btn {
            width: 100%;
            padding: 16px;
            background: var(--pmw-cyan);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .accept-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .accept-btn:not(:disabled):hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        /* ========================================
           MAIN APP STYLES (Hidden initially)
        ======================================== */
        #mainApp {
            display: none;
            padding-bottom: 40px;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Navigation */
        .nav {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .nav-logo {
            height: 50px;
            width: auto;
        }
        
        .nav-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .nav-title-main {
            font-size: 20px;
            font-weight: 800;
            color: var(--pmw-navy);
        }
        
        .nav-title-sub {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }
        
        .nav-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 800;
            color: #1a1a2e;
        }
        
        .guard-status {
            background: #dcfce7;
            color: #166534;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .guard-status.inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .nav-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            background: transparent;
            color: #64748b;
            transition: all 0.2s;
        }
        
        .nav-btn:hover { background: rgba(102, 126, 234, 0.1); }
        .nav-btn.active { background: var(--pmw-cyan); color: white; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .card-title { font-size: 24px; font-weight: 700; }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--pmw-cyan);
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #64748b;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: #1a1a2e;
        }
        
        .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--pmw-cyan);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f7fafc;
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        /* Status Badge */
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
        }
        
        .status-in {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-out {
            background: #dcfce7;
            color: #166534;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #f1f5f9;
            color: #1a1a2e;
        }
        
        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        
        /* Alert */
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .alert-success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #10b981;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Admin Panel */
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }
        
        .admin-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .admin-tab:hover {
            color: var(--pmw-cyan);
        }
        
        .admin-tab.active {
            color: var(--pmw-cyan);
            border-bottom-color: var(--pmw-cyan);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav {
                padding: 16px;
            }
            
            .nav-title {
                font-size: 16px;
            }
            
            .card {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 24px;
            }

            .terms-header h1 {
                font-size: 24px;
            }

            .terms-content {
                padding: 24px;
            }

            .terms-footer {
                padding: 20px 24px;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--pmw-cyan);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<!-- ========================================
     TERMS & CONDITIONS PAGE
======================================== -->
<div id="termsPage">
    <div class="terms-container">
        <div class="terms-header">
            <h1>üöõ OSHES Lorry Tracking System</h1>
            <p>Occupational Safety, Health, and Environment System</p>
        </div>

        <div class="terms-content">
            <h2>üìã Terms and Conditions</h2>
            <p>Welcome to the OSHES Lorry Tracking System. Before accessing the system, please read and accept the following terms and conditions.</p>

            <h2>üéØ Purpose of This System</h2>
            <p>This system is designed to:</p>
            <ul>
                <li>Track and record all lorry visits to the premises</li>
                <li>Maintain accurate records of driver information and visit times</li>
                <li>Ensure safety and security compliance</li>
                <li>Provide real-time monitoring for guards and administrators</li>
            </ul>

            <h2>üë§ User Responsibilities</h2>
            <p><strong>As a user of this system, you agree to:</strong></p>
            <ul>
                <li><strong>Accuracy:</strong> Provide accurate and truthful information when recording visits</li>
                <li><strong>Security:</strong> Keep your login credentials confidential and not share them with others</li>
                <li><strong>Proper Use:</strong> Use the system only for authorized tracking and monitoring purposes</li>
                <li><strong>Data Privacy:</strong> Respect the privacy of driver information and visit records</li>
                <li><strong>Reporting:</strong> Report any system errors or suspicious activities immediately</li>
            </ul>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Important:</strong> Unauthorized access, data manipulation, or misuse of this system may result in disciplinary action and/or legal consequences.
            </div>

            <h2>üîí Data Protection & Privacy</h2>
            <ul>
                <li>All data is stored securely and encrypted</li>
                <li>Personal information is handled in accordance with data protection regulations</li>
                <li>Access to data is restricted to authorized personnel only</li>
                <li>System logs and audit trails are maintained for security purposes</li>
            </ul>

            <h2>üì± System Usage Guidelines</h2>
            <ul>
                <li><strong>Check-In:</strong> Record lorry arrival immediately upon entry to premises</li>
                <li><strong>Verification:</strong> Verify driver identification and vehicle plate numbers</li>
                <li><strong>Check-Out:</strong> Record lorry departure before exit from premises</li>
                <li><strong>Shift Handover:</strong> Guards must properly end their shift and hand over to the next guard</li>
            </ul>

            <h2>üõ°Ô∏è Safety & Compliance</h2>
            <p>This system supports our commitment to:</p>
            <ul>
                <li>Workplace safety and security</li>
                <li>Occupational health regulations</li>
                <li>Environmental protection standards</li>
                <li>Quality management systems</li>
            </ul>

            <h2>üìû Support & Assistance</h2>
            <p>For technical support or questions about the system, please contact:</p>
            <ul>
                <li><strong>Admin Support:</strong> Contact your system administrator</li>
                <li><strong>Technical Issues:</strong> Report via the admin panel or supervisor</li>
                <li><strong>Emergency:</strong> Follow standard emergency protocols</li>
            </ul>

            <h2>‚úÖ Acknowledgment</h2>
            <p>By clicking "I Accept and Proceed" below, you acknowledge that you have read, understood, and agree to comply with these terms and conditions. You also confirm that you are authorized to use this system.</p>
        </div>

        <div class="terms-footer">
            <div class="checkbox-container">
                <input type="checkbox" id="acceptCheckbox">
                <label for="acceptCheckbox">
                    I have read and agree to the Terms and Conditions. I understand my responsibilities as a user of the OSHES Lorry Tracking System.
                </label>
            </div>
            <button class="accept-btn" id="acceptBtn" disabled>
                I Accept and Proceed to System
            </button>
        </div>
    </div>
</div>

<!-- ========================================
     MAIN APPLICATION (Hidden initially)
======================================== -->
<div id="mainApp">
    <div class="container">
        <!-- Navigation -->
        <div class="nav">
            <div class="nav-title" onclick="tripleClickAdminAccess(event)">
                üöõ OSHES Lorry Tracking
            </div>
            <div class="guard-status" id="guardStatus">
                <span id="guardStatusText">‚è∏Ô∏è No Active Shift</span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showGuardShiftModal()">üîÑ Start Shift</button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üöõ</div>
                <div class="stat-label">Currently In Premises</div>
                <div class="stat-value" id="currentlyIn">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-label">Total Today</div>
                <div class="stat-value" id="totalToday">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Checked Out</div>
                <div class="stat-value" id="checkedOut">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë§</div>
                <div class="stat-label">My Shift Records</div>
                <div class="stat-value" id="myShiftRecords">0</div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìù Lorry Check-In / Check-Out</h2>
                <div class="alert alert-error" id="errorAlert" style="display: none;"></div>
            </div>

            <!-- Search Driver -->
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchDriver"
                    placeholder="Search driver by ID, name, or lorry plate..."
                    onkeyup="searchDriver()"
                >
            </div>

            <!-- Driver Selection Dropdown -->
            <div class="form-group" id="driverDropdownContainer">
                <label class="form-label">Quick Select Registered Driver</label>
                <select class="form-select" id="driverSelect" onchange="fillDriverDetails()">
                    <option value="">-- Select a Driver --</option>
                </select>
            </div>

            <!-- Check-In Form -->
            <form id="checkInForm" onsubmit="handleCheckIn(event)">

                
                <div class="form-group">
                    <label class="form-label">Driver Name</label>
                    <input type="text" class="form-input" id="driverName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Lorry Plate Number</label>
                    <input type="text" class="form-input" id="lorryPlate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" id="company" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Purpose of Visit</label>
                    <input type="text" class="form-input" id="purpose" required>
                </div>
                
                <button type="submit" class="btn btn-success" style="width: 100%;">
                    ‚úÖ Check In Lorry
                </button>
            </form>
        </div>

        <!-- Active Lorries Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üöõ Currently In Premises</h2>
            </div>
            <div class="table-container">
                <table id="activeTable">
                    <thead>
                        <tr>
                            <th>Time In</th>
                            <th>Driver</th>
                            <th>Lorry Plate</th>
                            <th>Company</th>
                            <th>Purpose</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="activeTableBody">
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üì≠</div>
                                    <p>No lorries currently in premises</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- History Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìú Recent History</h2>
            </div>
            <div class="table-container">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Check In</th>
                            <th>Check Out</th>
                            <th>Driver</th>
                            <th>Lorry Plate</th>
                            <th>Company</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üìã</div>
                                    <p>No history records</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Guard Shift Modal -->
<div class="modal" id="shiftModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üîÑ Guard Shift Management</h3>
            <button class="close-btn" onclick="closeShiftModal()">√ó</button>
        </div>
        
        <div id="shiftStartSection">
            <div class="form-group">
                <label class="form-label">Select Guard</label>
                <select class="form-select" id="shiftGuardSelect">
                    <option value="">-- Select Your Name --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Shift Type</label>
                <select class="form-select" id="shiftType">
                    <option value="Day">Day Shift</option>
                    <option value="Night">Night Shift</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <input type="text" class="form-input" id="shiftNotes" placeholder="Any special notes...">
            </div>
            
            <button class="btn btn-success" style="width: 100%;" onclick="startShift()">
                ‚úÖ Start My Shift
            </button>
        </div>
        
        <div id="shiftEndSection" style="display: none;">
            <div class="alert alert-success">
                <strong>Active Shift:</strong> <span id="currentShiftInfo"></span>
            </div>
            
            <button class="btn btn-danger" style="width: 100%;" onclick="endShift()">
                üõë End My Shift
            </button>
        </div>
    </div>
</div>

<!-- Admin Panel Modal -->
<div class="modal" id="adminModal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3 class="modal-title">‚öôÔ∏è Admin Panel</h3>
            <button class="close-btn" onclick="closeAdminModal()">√ó</button>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchAdminTab('guards')">üë§ Guards</button>
            <button class="admin-tab" onclick="switchAdminTab('drivers')">üöó Drivers</button>
            <button class="admin-tab" onclick="switchAdminTab('logs')">üìä All Logs</button>
            <button class="admin-tab" onclick="switchAdminTab('shifts')">üîÑ Shifts</button>
        </div>

        <!-- Guards Tab -->
        <div class="tab-content active" id="guardsTab">
            <button class="btn btn-primary" onclick="showAddGuardForm()" style="margin-bottom: 20px;">
                ‚ûï Add Guard
            </button>
            <div id="addGuardForm" style="display: none; margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                <h4 style="margin-bottom: 16px;">Add New Guard</h4>
                <div class="form-group">
                    <label class="form-label">Guard Name</label>
                    <input type="text" class="form-input" id="newGuardName">
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-success" onclick="addGuard()">Save Guard</button>
                    <button class="btn btn-secondary" onclick="hideAddGuardForm()">Cancel</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Badge ID</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="guardsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Drivers Tab -->
        <div class="tab-content" id="driversTab">
            <button class="btn btn-primary" onclick="showAddDriverForm()" style="margin-bottom: 20px;">
                ‚ûï Add Driver
            </button>
            <div id="addDriverForm" style="display: none; margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                <h4 style="margin-bottom: 16px;">Register New Driver</h4>
                <div class="form-group">
                    <label class="form-label">Driver ID</label>
                    <input type="text" class="form-input" id="newDriverId">
                </div>
                <div class="form-group">
                    <label class="form-label">Driver Name</label>
                    <input type="text" class="form-input" id="newDriverName">
                </div>
                <div class="form-group">
                    <label class="form-label">Lorry Plate</label>
                    <input type="text" class="form-input" id="newDriverPlate">
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" id="newDriverCompany">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" class="form-input" id="newDriverPhone">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-success" onclick="addDriver()">Save Driver</button>
                    <button class="btn btn-secondary" onclick="hideAddDriverForm()">Cancel</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Driver ID</th>
                            <th>Name</th>
                            <th>Lorry Plate</th>
                            <th>Company</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="driversTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Logs Tab -->
        <div class="tab-content" id="logsTab">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Log ID</th>
                            <th>Check In</th>
                            <th>Check Out</th>
                            <th>Driver</th>
                            <th>Plate</th>
                            <th>Status</th>
                            <th>Guard (In)</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Shifts Tab -->
        <div class="tab-content" id="shiftsTab">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Guard</th>
                            <th>Shift Type</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="shiftsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// ========================================
// TERMS & CONDITIONS LOGIC
// ========================================
const acceptCheckbox = document.getElementById('acceptCheckbox');
const acceptBtn = document.getElementById('acceptBtn');
const termsPage = document.getElementById('termsPage');
const mainApp = document.getElementById('mainApp');

// Enable/disable accept button based on checkbox
acceptCheckbox.addEventListener('change', function() {
    acceptBtn.disabled = !this.checked;
});

// Handle accept button click
acceptBtn.addEventListener('click', function() {
    // Save acceptance to localStorage (so user doesn't see it again)
    localStorage.setItem('oshes_terms_accepted', 'true');
    localStorage.setItem('oshes_terms_accepted_date', new Date().toISOString());
    
    // Hide terms page and show main app
    termsPage.style.display = 'none';
    mainApp.style.display = 'block';
    
    // Initialize the main app
    init();
});

// Check if user has already accepted terms
window.addEventListener('DOMContentLoaded', function() {
    const termsAccepted = localStorage.getItem('oshes_terms_accepted');
    
    if (termsAccepted === 'true') {
        // User already accepted, go straight to app
        termsPage.style.display = 'none';
        mainApp.style.display = 'block';
        init();
    } else {
        // Show terms page first
        termsPage.style.display = 'flex';
        mainApp.style.display = 'none';
    }
});

// Admin function to reset terms (for testing)
function resetTermsAcceptance() {
    localStorage.removeItem('oshes_terms_accepted');
    localStorage.removeItem('oshes_terms_accepted_date');
    location.reload();
}

// ========================================
// MAIN APPLICATION LOGIC
// ========================================

// Supabase Configuration
const SUPABASE_URL = 'https://jgeldbgfmqgynoumkhcn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpnZWxkYmdmbXFneW5vdW1raGNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY4NDMyMjcsImV4cCI6MjA1MjQxOTIyN30.lFTv09J4hEfCq6RkBRbL7ktVOwSYkfgEvqaCy3OXC3A';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Global State
let currentShift = null;
let guards = [];
let drivers = [];
let visitLogs = [];
let guardShifts = [];

// Initialize App
async function init() {
    showLoading();
    await loadAllData();
    await checkActiveShift();
    updateAllUI();
    hideLoading();
}

function showLoading() {
    document.getElementById('errorAlert').innerHTML = '<div class="spinner"></div> Loading data...';
    document.getElementById('errorAlert').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('errorAlert').style.display = 'none';
}

// Load All Data
async function loadAllData() {
    try {
        const [guardsData, driversData, logsData, shiftsData] = await Promise.all([
            supabaseClient.from('guards').select('*').order('created_at', { ascending: false }),
            supabaseClient.from('drivers').select('*').order('created_at', { ascending: false }),
            supabaseClient.from('visit_logs').select('*').order('check_in_time', { ascending: false }),
            supabaseClient.from('guard_shifts').select('*').order('shift_start', { ascending: false })
        ]);

        guards = guardsData.data || [];
        drivers = driversData.data || [];
        visitLogs = logsData.data || [];
        guardShifts = shiftsData.data || [];

    } catch (error) {
        console.error('Error loading data:', error);
        showError('Error loading data. Please check database connection.');
    }
}

// Check Active Shift
async function checkActiveShift() {
    const activeShift = guardShifts.find(shift => shift.shift_end === null);
    if (activeShift) {
        currentShift = activeShift;
        updateGuardStatus();
    }
}

// Update Guard Status
function updateGuardStatus() {
    const statusEl = document.getElementById('guardStatus');
    const statusText = document.getElementById('guardStatusText');
    
    if (currentShift) {
        const guard = guards.find(g => g.id === currentShift.guard_id);
        statusEl.classList.remove('inactive');
        statusText.textContent = `‚úÖ ${guard?.name || 'Guard'} - ${currentShift.shift_type} Shift`;
    } else {
        statusEl.classList.add('inactive');
        statusText.textContent = '‚è∏Ô∏è No Active Shift';
    }
}

// Update All UI
function updateAllUI() {
    updateStats();
    updateActiveTable();
    updateHistoryTable();
    updateDriverDropdown();
    updateGuardDropdown();
    
    if (document.getElementById('adminModal').classList.contains('active')) {
        loadAdminData();
    }
}

// Update Statistics
function updateStats() {
    const currentlyIn = visitLogs.filter(log => log.status === 'in').length;
    const today = new Date().toISOString().split('T')[0];
    const totalToday = visitLogs.filter(log => 
        log.check_in_time.startsWith(today)
    ).length;
    const checkedOut = visitLogs.filter(log => 
        log.status === 'out' && log.check_in_time.startsWith(today)
    ).length;
    const myShiftRecords = currentShift 
        ? visitLogs.filter(log => log.guard_shift_id === currentShift.id).length 
        : 0;

    document.getElementById('currentlyIn').textContent = currentlyIn;
    document.getElementById('totalToday').textContent = totalToday;
    document.getElementById('checkedOut').textContent = checkedOut;
    document.getElementById('myShiftRecords').textContent = myShiftRecords;
}

// Update Active Table
function updateActiveTable() {
    const tbody = document.getElementById('activeTableBody');
    const activeLogs = visitLogs.filter(log => log.status === 'in');
    
    if (activeLogs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No lorries currently in premises</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = activeLogs.map(log => `
        <tr>
            <td>${formatDateTime(log.check_in_time)}</td>
            <td>${log.driver_name}</td>
            <td>${log.lorry_plate}</td>
            <td>${log.company}</td>
            <td>${log.purpose}</td>
            <td>
                <button class="btn btn-danger" onclick="checkOutLorry('${log.id}')">
                    üö™ Check Out
                </button>
            </td>
        </tr>
    `).join('');
}

// Update History Table
function updateHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    const recentLogs = visitLogs.slice(0, 20);
    
    if (recentLogs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No history records</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = recentLogs.map(log => `
        <tr>
            <td>${formatDateTime(log.check_in_time)}</td>
            <td>${log.check_out_time ? formatDateTime(log.check_out_time) : '-'}</td>
            <td>${log.driver_name}</td>
            <td>${log.lorry_plate}</td>
            <td>${log.company}</td>
            <td>
                <span class="status-badge status-${log.status}">
                    ${log.status === 'in' ? 'üü° IN' : '‚úÖ OUT'}
                </span>
            </td>
        </tr>
    `).join('');
}

// Update Driver Dropdown
function updateDriverDropdown() {
    const select = document.getElementById('driverSelect');
    const activeDrivers = drivers.filter(d => d.is_active);
    
    select.innerHTML = '<option value="">-- Select a Driver --</option>' +
        activeDrivers.map(driver => `
            <option value="${driver.id}">
                ${driver.name} - ${driver.lorry_plate} (${driver.company})
            </option>
        `).join('');
}

// Update Guard Dropdown
function updateGuardDropdown() {
    const select = document.getElementById('shiftGuardSelect');
    const activeGuards = guards.filter(g => g.is_active);
    
    select.innerHTML = '<option value="">-- Select Your Name --</option>' +
        activeGuards.map(guard => `
            <option value="${guard.id}">
                ${guard.name}${guard.badge_id ? ' - ' + guard.badge_id : ''}
            </option>
        `).join('');
}

// Fill Driver Details
function fillDriverDetails() {
    const select = document.getElementById('driverSelect');
    const selectedId = select.value;
    
    if (!selectedId) {
        // Clear form
        document.getElementById('driverId').value = '';
        document.getElementById('driverName').value = '';
        document.getElementById('lorryPlate').value = '';
        document.getElementById('company').value = '';
        return;
    }
    
    const driver = drivers.find(d => d.id === selectedId);
    if (driver) {
        document.getElementById('driverId').value = driver.driver_id;
        document.getElementById('driverName').value = driver.name;
        document.getElementById('lorryPlate').value = driver.lorry_plate;
        document.getElementById('company').value = driver.company;
    }
}

// Search Driver
function searchDriver() {
    const searchTerm = document.getElementById('searchDriver').value.toLowerCase();
    
    if (searchTerm.length < 2) {
        updateDriverDropdown();
        return;
    }
    
    const filteredDrivers = drivers.filter(d => 
        d.is_active && (
            d.driver_id.toLowerCase().includes(searchTerm) ||
            d.name.toLowerCase().includes(searchTerm) ||
            d.lorry_plate.toLowerCase().includes(searchTerm) ||
            d.company.toLowerCase().includes(searchTerm)
        )
    );
    
    const select = document.getElementById('driverSelect');
    select.innerHTML = '<option value="">-- Search Results --</option>' +
        filteredDrivers.map(driver => `
            <option value="${driver.id}">
                ${driver.name} - ${driver.lorry_plate} (${driver.company})
            </option>
        `).join('');
}

// Handle Check In
async function handleCheckIn(event) {
    event.preventDefault();
    
    if (!currentShift) {
        showError('Please start your shift first!');
        return;
    }
    
    const driverId = document.getElementById('driverId').value;
    const driverName = document.getElementById('driverName').value;
    const lorryPlate = document.getElementById('lorryPlate').value.toUpperCase();
    const company = document.getElementById('company').value;
    const purpose = document.getElementById('purpose').value;
    
    const guard = guards.find(g => g.id === currentShift.guard_id);
    
    const logData = {
        log_id: 'LOG-' + Date.now(),
        driver_id: null,
        driver_name: driverName,
        lorry_plate: lorryPlate,
        company: company,
        purpose: purpose,
        check_in_time: new Date().toISOString(),
        status: 'in',
        checked_in_by_guard_id: currentShift.guard_id,
        checked_in_by_guard_name: guard?.name,
        guard_shift_id: currentShift.id
    };
    
    try {
        const { data, error } = await supabaseClient
            .from('visit_logs')
            .insert([logData])
            .select();
            
        if (error) throw error;
        
        // Reset form
        document.getElementById('checkInForm').reset();
        document.getElementById('driverSelect').value = '';
        
        // Reload data
        await loadAllData();
        updateAllUI();
        
        alert('‚úÖ Lorry checked in successfully!');
        
    } catch (error) {
        console.error('Error checking in:', error);
        showError('Failed to check in lorry: ' + error.message);
    }
}

// Check Out Lorry
async function checkOutLorry(logId) {
    if (!currentShift) {
        showError('Please start your shift first!');
        return;
    }
    
    if (!confirm('Check out this lorry?')) return;
    
    const guard = guards.find(g => g.id === currentShift.guard_id);
    
    try {
        const { error } = await supabaseClient
            .from('visit_logs')
            .update({
                status: 'out',
                check_out_time: new Date().toISOString(),
                checked_out_by_guard_id: currentShift.guard_id,
                checked_out_by_guard_name: guard?.name
            })
            .eq('id', logId);
            
        if (error) throw error;
        
        await loadAllData();
        updateAllUI();
        
        alert('‚úÖ Lorry checked out successfully!');
        
    } catch (error) {
        console.error('Error checking out:', error);
        showError('Failed to check out lorry: ' + error.message);
    }
}

// Show/Hide Shift Modal
function showGuardShiftModal() {
    document.getElementById('shiftModal').classList.add('active');
    
    if (currentShift) {
        const guard = guards.find(g => g.id === currentShift.guard_id);
        document.getElementById('currentShiftInfo').textContent = 
            `${guard?.name || 'Guard'} - ${currentShift.shift_type} (Started: ${formatDateTime(currentShift.shift_start)})`;
        document.getElementById('shiftStartSection').style.display = 'none';
        document.getElementById('shiftEndSection').style.display = 'block';
    } else {
        document.getElementById('shiftStartSection').style.display = 'block';
        document.getElementById('shiftEndSection').style.display = 'none';
    }
}

function closeShiftModal() {
    document.getElementById('shiftModal').classList.remove('active');
}

// Start Shift
async function startShift() {
    const guardId = document.getElementById('shiftGuardSelect').value;
    const shiftType = document.getElementById('shiftType').value;
    const notes = document.getElementById('shiftNotes').value;
    
    if (!guardId) {
        alert('Please select your name!');
        return;
    }
    
    // Check if guard already has an active shift
    const existingShift = guardShifts.find(s => s.guard_id === guardId && s.shift_end === null);
    if (existingShift) {
        alert('You already have an active shift! Please end it first.');
        return;
    }
    
    const shiftData = {
        guard_id: guardId,
        shift_type: shiftType,
        shift_start: new Date().toISOString(),
        notes: notes || null
    };
    
    try {
        const { data, error } = await supabaseClient
            .from('guard_shifts')
            .insert([shiftData])
            .select();
            
        if (error) throw error;
        
        currentShift = data[0];
        await loadAllData();
        updateGuardStatus();
        updateAllUI();
        closeShiftModal();
        
        alert('‚úÖ Shift started successfully!');
        
    } catch (error) {
        console.error('Error starting shift:', error);
        alert('Failed to start shift: ' + error.message);
    }
}

// End Shift
async function endShift() {
    if (!confirm('End your current shift?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('guard_shifts')
            .update({ shift_end: new Date().toISOString() })
            .eq('id', currentShift.id);
            
        if (error) throw error;
        
        currentShift = null;
        await loadAllData();
        updateGuardStatus();
        updateAllUI();
        closeShiftModal();
        
        alert('‚úÖ Shift ended successfully!');
        
    } catch (error) {
        console.error('Error ending shift:', error);
        alert('Failed to end shift: ' + error.message);
    }
}

// Admin Panel
let adminClickCount = 0;
let adminClickTimer = null;

function tripleClickAdminAccess(event) {
    adminClickCount++;
    
    if (adminClickTimer) clearTimeout(adminClickTimer);
    
    if (adminClickCount === 3) {
        const password = prompt('Enter admin password:');
        if (password === 'admin123') {
            openAdminPanel();
        } else {
            alert('Incorrect password!');
        }
        adminClickCount = 0;
    }
    
    adminClickTimer = setTimeout(() => {
        adminClickCount = 0;
    }, 1000);
}

function openAdminPanel() {
    document.getElementById('adminModal').classList.add('active');
    loadAdminData();
}

function closeAdminModal() {
    document.getElementById('adminModal').classList.remove('active');
}

function switchAdminTab(tab) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
    
    loadAdminData();
}

async function loadAdminData() {
    await loadAllData();
    
    // Load Guards
    const guardsBody = document.getElementById('guardsTableBody');
    guardsBody.innerHTML = guards.map(guard => `
        <tr>
            <td>${guard.name}</td>
            <td>${guard.badge_id || '-'}</td>
            <td>
                <span class="status-badge ${guard.is_active ? 'status-out' : 'status-in'}">
                    ${guard.is_active ? '‚úÖ Active' : '‚ùå Inactive'}
                </span>
            </td>
            <td>${formatDate(guard.created_at)}</td>
            <td>
                <button class="btn btn-secondary" onclick="toggleGuardStatus('${guard.id}', ${!guard.is_active})">
                    ${guard.is_active ? 'Deactivate' : 'Activate'}
                </button>
            </td>
        </tr>
    `).join('');
    
    // Load Drivers
    const driversBody = document.getElementById('driversTableBody');
    driversBody.innerHTML = drivers.map(driver => `
        <tr>
            <td>${driver.driver_id}</td>
            <td>${driver.name}</td>
            <td>${driver.lorry_plate}</td>
            <td>${driver.company}</td>
            <td>${driver.phone || '-'}</td>
            <td>
                <button class="btn btn-secondary" onclick="toggleDriverStatus('${driver.id}', ${!driver.is_active})">
                    ${driver.is_active ? 'Deactivate' : 'Activate'}
                </button>
            </td>
        </tr>
    `).join('');
    
    // Load Logs
    const logsBody = document.getElementById('logsTableBody');
    logsBody.innerHTML = visitLogs.map(log => `
        <tr>
            <td>${log.log_id}</td>
            <td>${formatDateTime(log.check_in_time)}</td>
            <td>${log.check_out_time ? formatDateTime(log.check_out_time) : '-'}</td>
            <td>${log.driver_name}</td>
            <td>${log.lorry_plate}</td>
            <td>
                <span class="status-badge status-${log.status}">
                    ${log.status === 'in' ? 'üü° IN' : '‚úÖ OUT'}
                </span>
            </td>
            <td>${log.checked_in_by_guard_name || '-'}</td>
        </tr>
    `).join('');
    
    // Load Shifts
    const shiftsBody = document.getElementById('shiftsTableBody');
    shiftsBody.innerHTML = guardShifts.map(shift => {
        const guard = guards.find(g => g.id === shift.guard_id);
        const duration = shift.shift_end 
            ? calculateDuration(shift.shift_start, shift.shift_end)
            : 'Active';
        
        return `
            <tr>
                <td>${guard?.name || 'Unknown'}</td>
                <td>${shift.shift_type}</td>
                <td>${formatDateTime(shift.shift_start)}</td>
                <td>${shift.shift_end ? formatDateTime(shift.shift_end) : 'Active'}</td>
                <td>${duration}</td>
                <td>${shift.notes || '-'}</td>
            </tr>
        `;
    }).join('');
}

// Add Guard
function showAddGuardForm() {
    document.getElementById('addGuardForm').style.display = 'block';
}

function hideAddGuardForm() {
    document.getElementById('addGuardForm').style.display = 'none';
    document.getElementById('newGuardName').value = '';
    document.getElementById('newGuardBadge').value = '';
}

async function addGuard() {
    const name = document.getElementById('newGuardName').value.trim();
    const badgeId = document.getElementById('newGuardBadge').value.trim();
    
    if (!name) {
        alert('Please enter guard name!');
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('guards')
            .insert([{ name, badge_id: badgeId || null }]);
            
        if (error) throw error;
        
        hideAddGuardForm();
        await loadAdminData();
        updateGuardDropdown();
        alert('‚úÖ Guard added successfully!');
        
    } catch (error) {
        console.error('Error adding guard:', error);
        alert('Failed to add guard: ' + error.message);
    }
}

async function toggleGuardStatus(guardId, newStatus) {
    try {
        const { error } = await supabaseClient
            .from('guards')
            .update({ is_active: newStatus })
            .eq('id', guardId);
            
        if (error) throw error;
        
        await loadAdminData();
        updateGuardDropdown();
        
    } catch (error) {
        console.error('Error updating guard:', error);
        alert('Failed to update guard: ' + error.message);
    }
}

// Add Driver
function showAddDriverForm() {
    document.getElementById('addDriverForm').style.display = 'block';
}

function hideAddDriverForm() {
    document.getElementById('addDriverForm').style.display = 'none';
    document.getElementById('newDriverId').value = '';
    document.getElementById('newDriverName').value = '';
    document.getElementById('newDriverPlate').value = '';
    document.getElementById('newDriverCompany').value = '';
    document.getElementById('newDriverPhone').value = '';
}

async function addDriver() {
    const driverId = document.getElementById('newDriverId').value.trim();
    const name = document.getElementById('newDriverName').value.trim();
    const lorryPlate = document.getElementById('newDriverPlate').value.trim().toUpperCase();
    const company = document.getElementById('newDriverCompany').value.trim();
    const phone = document.getElementById('newDriverPhone').value.trim();
    
    if (!driverId || !name || !lorryPlate || !company) {
        alert('Please fill in all required fields!');
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('drivers')
            .insert([{
                driver_id: driverId,
                name,
                lorry_plate: lorryPlate,
                company,
                phone: phone || null
            }]);
            
        if (error) throw error;
        
        hideAddDriverForm();
        await loadAdminData();
        updateDriverDropdown();
        alert('‚úÖ Driver added successfully!');
        
    } catch (error) {
        console.error('Error adding driver:', error);
        alert('Failed to add driver: ' + error.message);
    }
}

async function toggleDriverStatus(driverId, newStatus) {
    try {
        const { error } = await supabaseClient
            .from('drivers')
            .update({ is_active: newStatus })
            .eq('id', driverId);
            
        if (error) throw error;
        
        await loadAdminData();
        updateDriverDropdown();
        
    } catch (error) {
        console.error('Error updating driver:', error);
        alert('Failed to update driver: ' + error.message);
    }
}

// Utility Functions
function formatDateTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString('en-MY', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-MY', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function calculateDuration(start, end) {
    const duration = new Date(end) - new Date(start);
    const hours = Math.floor(duration / (1000 * 60 * 60));
    const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
    return `${hours}h ${minutes}m`;
}

function showError(message) {
    const alert = document.getElementById('errorAlert');
    alert.textContent = '‚ùå ' + message;
    alert.style.display = 'flex';
    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}

// Close modals on outside click
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.classList.remove('active');
        }
    });
}
</script>

</body>
</html>
